<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>éŒ„éŸ³ + æ’­æ”¾ + ä¸Šå‚³</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            background-color: #111;
            color: white;
            padding: 2rem;
            font-family: sans-serif;
        }
        .progress-container {
            margin-top: 1rem;
        }
        select.form-select {
            background-color: #fff;
            color: #000;
        }
    </style>
</head>
<body>

<h2>ğŸ™ï¸ éŒ„éŸ³ + æ’­æ”¾ + ä¸Šå‚³</h2>
<p>â±ï¸ éŒ„éŸ³æ™‚é–“ï¼š<span id="recordTimer">0</span> ç§’</p>

<div class="mb-3">
    <button id="startBtn" class="btn btn-success me-2">é–‹å§‹éŒ„éŸ³</button>
    <button id="stopBtn" class="btn btn-warning me-2" disabled>åœæ­¢éŒ„éŸ³</button>
    <button id="uploadBtn" class="btn btn-primary" disabled>ä¸Šå‚³éŒ„éŸ³</button>
</div>

<hr>

<h4>ğŸ§ æ’­æ”¾å€</h4>
<audio id="player" preload="metadata"></audio>

<div class="progress-container">
    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%;"></div>
    </div>
    <p class="text-end mt-1"><span id="timeDisplay">00:00 / 00:00</span></p>
</div>
<button id="playBtn" class="btn btn-primary mt-2 mb-4" disabled>â–¶ æ’­æ”¾</button>

<hr>

<h4>ğŸ“¦ å·²ä¸Šå‚³éŒ„éŸ³æ¸…å–®</h4>
<select id="audioList" class="form-select" disabled>
    <option selected disabled>è«‹é¸æ“‡éŒ„éŸ³æª”...</option>
</select>

<script>
    let mediaRecorder, audioChunks = [], audioBlob;
    let recordSeconds = 0, timerInterval;
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const recordTimer = document.getElementById('recordTimer');
    const player = document.getElementById('player');
    const progressBar = document.getElementById('progressBar');
    const timeDisplay = document.getElementById('timeDisplay');
    const audioList = document.getElementById('audioList');
    const playBtn = document.getElementById('playBtn');

    function startTimer() {
        recordSeconds = 0;
        recordTimer.textContent = '0';
        timerInterval = setInterval(() => {
            recordSeconds++;
            recordTimer.textContent = recordSeconds;
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
    }

    function formatTime(sec) {
        const m = String(Math.floor(sec / 60)).padStart(2, '0');
        const s = String(Math.floor(sec % 60)).padStart(2, '0');
        return `${m}:${s}`;
    }

    startBtn.onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                stopTimer();
                audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(audioBlob);
                player.src = url;
                uploadBtn.disabled = false;
                playBtn.disabled = false;
                timeDisplay.textContent = "00:00 / 00:00";
            };

            mediaRecorder.start();
            startTimer();
            startBtn.disabled = true;
            stopBtn.disabled = false;
        } catch (e) {
            Swal.fire("éŒ¯èª¤", "âŒ ç„¡æ³•å•Ÿç”¨éº¥å…‹é¢¨", "error");
        }
    };

    stopBtn.onclick = () => {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
    };

    uploadBtn.onclick = () => {
        if (!audioBlob) return;
        const filename = `recording-${Date.now()}.webm`;
        const formData = new FormData();
        formData.append("file", audioBlob, filename);

        fetch("/api/upload", {
            method: "POST",
            body: formData
        }).then(res => res.text())
            .then(() => {
                Swal.fire("âœ… æˆåŠŸ", "æª”æ¡ˆå·²ä¸Šå‚³", "success");
                addToList(filename);
                uploadBtn.disabled = true;
            })
            .catch(() => Swal.fire("ä¸Šå‚³å¤±æ•—", "è«‹ç¨å¾Œå†è©¦", "error"));
    };

    playBtn.onclick = () => {
        if (player.src) {
            player.play();
        }
    };

    function addToList(filename) {
        const option = document.createElement("option");
        option.text = filename;
        option.value = `/uploads/${filename}`;
        audioList.appendChild(option);
        audioList.disabled = false;
    }

    audioList.onchange = () => {
        const selected = audioList.value;
        if (!selected) return;

        player.src = selected;
        player.load();
        player.onloadedmetadata = () => {
            playBtn.disabled = false;
            progressBar.style.width = "0%";
            if (!isNaN(player.duration)) {
                timeDisplay.textContent = `00:00 / ${formatTime(player.duration)}`;
            }
        };
    };

    player.ontimeupdate = () => {
        if (!player.duration || isNaN(player.duration)) return;
        const percent = (player.currentTime / player.duration) * 100;
        progressBar.style.width = `${percent}%`;
        timeDisplay.textContent = `${formatTime(player.currentTime)} / ${formatTime(player.duration)}`;
    };

    // åˆå§‹åŒ–æ¸…å–®
    window.onload = () => {
        fetch("/api/files")
            .then(res => res.json())
            .then(files => {
                files.forEach(addToList);
            })
            .catch(() => {
                console.error("âŒ ç„¡æ³•è¼‰å…¥éŒ„éŸ³æ¸…å–®");
            });
    };
</script>

</body>
</html>
